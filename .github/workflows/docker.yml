name: Docker

on: [push, pull_request]

jobs:
  
  clean-up:
    name: Clean up
    runs-on: ubuntu-latest
    steps:

      - name: Clean up
        run: rm -rf *
        
  prerequisites:
    runs-on: ubuntu-latest
    needs: clean-up
    steps:
      
      - uses: actions/checkout@v4
        name: Checkout repository
        with:
          submodules: true
          
      - uses: robinraju/release-downloader@v1.8
        name: Download PythonAPI
        with:
          repository: carla-compose/carla-simulator
          latest: true
          fileName: PythonAPI.tar.gz
          extract: true
          out-file-path: docker/additional-files
          
      - name: Remove PythonAPI.tar.gz
        run: rm docker/additional-files/PythonAPI.tar.gz

  docker-ros:
    strategy:
      matrix:
        include:
          - ros: ros2
            rosdistro: humble
            command: ros2 launch carla_ros_bridge carla_ros_bridge.launch.py
          - ros: ros
            rosdistro: noetic
            command: roslaunch carla_ros_bridge carla_ros_bridge.launch
    runs-on: ubuntu-latest
    needs: prerequisites
    steps:
      - uses: ika-rwth-aachen/docker-ros@main   # fix to @v1.4.0 when released
        name: Run docker-ros pipeline for ${{ matrix.ros }}:${{ matrix.rosdistro }}
        with:
          base-image: rwthika/${{ matrix.ros }}:${{ matrix.rosdistro }}
          command: ${{ matrix.command }}
          target: run
          platform: amd64
          registry: docker.io
          registry-user: ${{ secrets.DOCKER_USERNAME }}
          registry-password: ${{ secrets.DOCKER_PASSWORD }}
          image-name: rwthika/carla-ros-bridge
          image-tag: ${{ matrix.ros }}
          enable-singlearch-push: true
          enable-push-as-latest: true
          enable-checkout: false
